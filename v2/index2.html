<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Time Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .clock-display {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .controls {
            background: white;
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .collapse-toggle {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .collapse-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .collapsible-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            margin-bottom: 0;
            opacity: 0;
        }

        .quarter-selector {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            margin: 10px 0;
        }

        .quarter-button {
            flex: 1;
            padding: 12px 0;
            font-size: 1.2em;
            font-weight: 600;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f5f5f5;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quarter-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .control-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .control-row label {
            flex: 1;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .control-row input, .control-row select {
            flex: 2;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .clock-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .clock-controls button {
            flex: 1;
        }

        .start-button {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        }

        .stop-button {
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
        }

        .share-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .players-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            justify-content: center;
        }

        .player-card {
            width: calc(33.333% - 10px);
            min-width: 100px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .player-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .player-card.on-field {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #1a1a1a;
        }

        .player-card.warning {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #1a1a1a;
        }

        .player-card.alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .player-card.not-played {
            background: #e2e3e5;
            color: #666;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .player-time {
            font-size: 1.3em;
            font-family: 'Courier New', monospace;
        }

        .captain-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.2em;
        }

        .goaltender-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 1.2em;
        }

        .alert-icon {
            position: absolute;
            top: 25px;
            left: 5px;
            font-size: 1.2em;
            animation: ring 1s infinite;
        }

        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .goal-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #667eea;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .team-score {
            padding: 5px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
        }

        .other-score {
            padding: 5px 15px;
            background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
            color: white;
            border-radius: 20px;
        }

        .event-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 20px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            font-size: 1.3em;
            font-weight: bold;
        }

        .modal-body {
            padding: 20px;
        }

        .player-list {
            margin: 20px 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .player-item input {
            flex: 1;
            margin: 0 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .player-item button {
            padding: 8px 15px;
            font-size: 0.9em;
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .add-player-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-player-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .history-section {
            background: white;
            margin: 10px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .history-section h2 {
            color: #667eea;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        .event-modal select {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin: 10px 0;
        }

        .event-type-container {
            margin: 20px 0;
        }

        .event-options {
            margin: 20px 0;
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .event-info {
            flex: 1;
        }

        .event-actions {
            display: flex;
            gap: 5px;
        }

        .event-actions button {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .edit-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .delete-button {
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
        }

        .warning-modal {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        .warning-modal h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .warning-modal .modal-footer {
            justify-content: center;
        }

        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .import-modal {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        .import-modal h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .share-modal {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            text-align: left;
        }

        .share-modal h3 {
            color: #0c5460;
            margin-bottom: 15px;
            text-align: center;
        }

        .share-options {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .share-options h4 {
            margin-bottom: 10px;
            color: #0c5460;
        }

        .share-option {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        .share-option input {
            margin-right: 8px;
        }

        .select-all-options {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 6px;
        }

        .select-all-options button {
            margin-right: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .player-card {
                width: calc(33.333% - 7px);
                padding: 10px;
            }
            
            .player-name {
                font-size: 0.9em;
            }
            
            .player-time {
                font-size: 1.1em;
            }
            
            h1 {
                font-size: 1.3em;
            }
            
            .clock-display {
                font-size: 2em;
            }
        }

        @media (max-width: 480px) {
            .player-card {
                width: calc(30% - 5px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="team-title">Soccer Time Tracker</h1>
        <div class="clock-display" id="quarter-clock">0:00</div>
        <div class="sound-toggle" onclick="toggleSound()">
            <span id="sound-status">🔊</span>
        </div>
    </div>

    <div class="controls">
        <div class="controls-header">
            <h3 style="margin: 0; color: #667eea;">Controls</h3>
            <button class="collapse-toggle" onclick="toggleControls()" id="collapse-toggle">🔼</button>
        </div>

        <div class="collapsible-content" id="collapsible-content">
            <div class="control-row">
                <label for="rotation">Rotation time:</label>
                <input type="number" id="rotation" value="5" min="1" onchange="saveRotationTime()">
            </div>

            <div class="control-row">
                <label for="team-select">Team:</label>
                <select id="team-select" onchange="loadSelectedTeam()">
                    <option value="">Select Team</option>
                </select>
            </div>

            <div class="control-row">
                <label for="captain-select">Captain:</label>
                <select id="captain-select" onchange="updatePlayerDisplay()">
                    <option value="">None</option>
                </select>
            </div>

            <div class="control-row">
                <label for="goaltender-select">Goaltender:</label>
                <select id="goaltender-select" onchange="updatePlayerDisplay()">
                    <option value="">None</option>
                </select>
            </div>

            <div class="clock-controls">
                <button onclick="showManagePlayersModal()">👥 Manage Players</button>
                <button onclick="createTeam()">➕ Create Team</button>
            </div>

            <div class="clock-controls">
                <button onclick="showResetWarning()">🔄 Reset Times</button>
                <button onclick="showManageEventsModal()">📝 Manage Events</button>
                <button class="share-button" onclick="showShareModal()">🔗 Share Team</button>
            </div>
        </div>

        <label>Select Quarter:</label>
        <div class="quarter-selector" id="quarter">
            <button data-quarter="Q1" class="quarter-button active">Q1</button>
            <button data-quarter="Q2" class="quarter-button">Q2</button>
            <button data-quarter="Q3" class="quarter-button">Q3</button>
            <button data-quarter="Q4" class="quarter-button">Q4</button>
            <button data-quarter="OT" class="quarter-button">OT</button>
        </div>

        <div class="clock-controls">
            <button class="start-button" onclick="startQuarterClock()">▶ Start Clock</button>
            <button class="stop-button" onclick="stopQuarterClock()">⏸ Stop Clock</button>
        </div>
    </div>

    <div class="players-grid" id="players"></div>

    <div class="history-section">
        <div class="history-section-header">
            <h2>Rotation History</h2>
            <button class="collapse-toggle" onclick="toggleRotationHistory()" id="rotation-toggle">🔽</button>
        </div>
        <div id="rotation-log" class="collapsible-content collapsed"></div>
    </div>

    <div class="history-section">
        <h2>Events</h2>
        <div id="events-log"></div>
    </div>

    <div class="goal-section">
        <div class="score-display">
            <span class="team-score" id="team-score">Team: 0</span>
        </div>
        <div class="score-display">
            <span class="other-score" id="other-score">Other: 0</span>
        </div>
        <button class="event-button" onclick="showEventModal()">📝 Log Event</button>
    </div>

    <!-- Manage Players Modal -->
    <div id="manage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Manage Players
            </div>
            <div class="modal-body">
                <div class="add-player-row">
                    <input type="text" id="new-player-name" placeholder="Enter player name">
                    <button onclick="addPlayerFromModal()">➕ Add</button>
                </div>
                <div class="player-list" id="player-list"></div>
            </div>
            <div class="modal-footer">
                <button onclick="savePlayersFromModal()">✅ Save</button>
                <button onclick="closeManageModal()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal event-modal">
        <div class="modal-content">
            <div class="modal-header">
                Log Event
            </div>
            <div class="modal-body">
                <div class="event-type-container">
                    <label for="event-type">Event Type:</label>
                    <select id="event-type" onchange="updateEventOptions()">
                        <option value="">Select Event Type</option>
                        <option value="goal">⚽ Goal</option>
                        <option value="penalty">🚨 Penalty Point</option>
                        <option value="save">🛡️ Goal Prevented</option>
                        <option value="injury">🤕 Player Injury</option>
                        <option value="cleat">👟 Lost Cleat</option>
                        <option value="laces">👟 Untied Laces</option>
                        <option value="headbutt">🤕 Ball Head-butt</option>
                    </select>
                </div>
                <div class="event-options" id="event-options"></div>
            </div>
            <div class="modal-footer">
                <button onclick="recordEvent()">✅ Record Event</button>
                <button onclick="closeEventModal()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Events Modal -->
    <div id="manage-events-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Manage Events
            </div>
            <div class="modal-body">
                <button onclick="showAddEventModal()" style="margin-bottom: 15px;">➕ Add Event</button>
                <div class="events-list" id="events-list"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeManageEventsModal()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="modal event-modal">
        <div class="modal-content">
            <div class="modal-header">
                Add Event
            </div>
            <div class="modal-body">
                <div class="event-type-container">
                    <label for="add-event-type">Event Type:</label>
                    <select id="add-event-type" onchange="updateAddEventOptions()">
                        <option value="">Select Event Type</option>
                        <option value="goal">⚽ Goal</option>
                        <option value="penalty">🚨 Penalty Point</option>
                        <option value="save">🛡️ Goal Prevented</option>
                        <option value="injury">🤕 Player Injury</option>
                        <option value="cleat">👟 Lost Cleat</option>
                        <option value="laces">👟 Untied Laces</option>
                        <option value="headbutt">🤕 Ball Head-butt</option>
                    </select>
                </div>
                <div class="control-row">
                    <label for="add-event-quarter">Quarter:</label>
                    <select id="add-event-quarter">
                        <option value="Q1">Q1</option>
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                        <option value="OT">OT</option>
                    </select>
                </div>
                <div class="event-options" id="add-event-options"></div>
            </div>
            <div class="modal-footer">
                <button onclick="addEvent()">✅ Add Event</button>
                <button onclick="closeAddEventModal()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="edit-event-modal" class="modal event-modal">
        <div class="modal-content">
            <div class="modal-header">
                Edit Event
            </div>
            <div class="modal-body">
                <div class="event-type-container">
                    <label for="edit-event-type">Event Type:</label>
                    <select id="edit-event-type" onchange="updateEditEventOptions()">
                        <option value="">Select Event Type</option>
                        <option value="goal">⚽ Goal</option>
                        <option value="penalty">🚨 Penalty Point</option>
                        <option value="save">🛡️ Goal Prevented</option>
                        <option value="injury">🤕 Player Injury</option>
                        <option value="cleat">👟 Lost Cleat</option>
                        <option value="laces">👟 Untied Laces</option>
                        <option value="headbutt">🤕 Ball Head-butt</option>
                    </select>
                </div>
                <div class="event-options" id="edit-event-options"></div>
            </div>
            <div class="modal-footer">
                <button onclick="saveEditedEvent()">✅ Save</button>
                <button onclick="closeEditEventModal()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reset Warning Modal -->
    <div id="reset-warning-modal" class="modal">
        <div class="modal-content warning-modal">
            <h3>⚠️ Warning!</h3>
            <p>Resetting will clear out the rotation history as well as the events history.</p>
            <p>Are you sure you want to do this?</p>
            <div class="modal-footer">
                <button onclick="confirmReset()" style="background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);">Yes, Reset Everything</button>
                <button onclick="closeResetWarning()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content import-modal">
            <h3>📥 Import Team Data</h3>
            <p>You're about to import team data that was shared with you.</p>
            <p>This will overwrite your current data for this team.</p>
            <p>Do you want to continue?</p>
            <div class="modal-footer">
                <button onclick="confirmImport()">Yes, Import</button>
                <button onclick="cancelImport()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
        <div class="modal-content share-modal">
            <h3>🔗 Share Team Data</h3>

            <div class="share-options">
                <h4>Select what to share:</h4>
                <div class="select-all-options">
                    <button onclick="selectAllShareOptions()">Select All</button>
                    <button onclick="deselectAllShareOptions()">Deselect All</button>
                </div>
                <div class="share-option" style="display:none">
                    <input type="checkbox" id="share-players" checked disabled>
                    <label for="share-players">Players and Captain (always included)</label>
                </div>
                <div class="share-option">
                    <input type="checkbox" id="share-times">
                    <label for="share-times">Player Clocks</label>
                </div>
                <div class="share-option">
                    <input type="checkbox" id="share-rotation">
                    <label for="share-rotation">Rotation History</label>
                </div>
                <div class="share-option">
                    <input type="checkbox" id="share-events" checked>
                    <label for="share-events">Event History</label>
                </div>
                <div class="share-option">
                    <input type="checkbox" id="share-quarters">
                    <label for="share-quarters">Quarter Clocks</label>
                </div>
            </div>
            <p>Player roster always included in sharing link</p>

            <div class="modal-footer">
                <button onclick="generateAndCopyShareUrl()" style="width: 100%; margin-bottom: 15px;">Generate & Copy Share Link</button>
                <button onclick="closeShareModal()" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let teams = {};
        let currentTeam = '';
        let tempPlayers = [];
        let teamQuarterClocks = {};
        let quarterTimerInterval = null;
        let quarterStartTime = null;
        let currentQuarter = 'Q1';
        let events = [];
        let soundEnabled = true;
        let updateInterval = null;
        let editingEventIndex = -1;
        let pendingImportData = null;
        let controlsCollapsed = false;
        let rotationHistoryCollapsed = true;

        // Audio context for notification sound
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext = null;

        // Quarter clock persistence
        let quarterClockState = {
            isRunning: false,
            startTime: null,
            elapsedTime: 0
        };

        function playDing() {
            if (!soundEnabled) return;
            
            if (!audioContext) {
                audioContext = new AudioContext();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 880; // A5 note
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? '🔊' : '🔇';
            localStorage.setItem('soundEnabled', soundEnabled);
        }

        function toggleControls() {
            const content = document.getElementById('collapsible-content');
            const toggle = document.getElementById('collapse-toggle');
            
            controlsCollapsed = !controlsCollapsed;
            
            if (controlsCollapsed) {
                content.classList.add('collapsed');
                toggle.textContent = '🔽';
            } else {
                content.classList.remove('collapsed');
                toggle.textContent = '🔼';
            }
            
            localStorage.setItem('controlsCollapsed', controlsCollapsed);
        }

        function toggleRotationHistory() {
            const content = document.getElementById('rotation-log');
            const toggle = document.getElementById('rotation-toggle');
            
            rotationHistoryCollapsed = !rotationHistoryCollapsed;
            
            if (rotationHistoryCollapsed) {
                content.classList.add('collapsed');
                toggle.textContent = '🔽';
            } else {
                content.classList.remove('collapsed');
                toggle.textContent = '🔼';
            }
            
            localStorage.setItem('rotationHistoryCollapsed', rotationHistoryCollapsed);
        }

        function saveRotationTime() {
            if (!currentTeam) return;
            
            const rotationTime = document.getElementById('rotation').value;
            const teamRotationTimes = JSON.parse(localStorage.getItem('teamRotationTimes')) || {};
            teamRotationTimes[currentTeam] = rotationTime;
            localStorage.setItem('teamRotationTimes', JSON.stringify(teamRotationTimes));
        }

        function loadRotationTime() {
            if (!currentTeam) return;
            
            const teamRotationTimes = JSON.parse(localStorage.getItem('teamRotationTimes')) || {};
            if (teamRotationTimes[currentTeam]) {
                document.getElementById('rotation').value = teamRotationTimes[currentTeam];
            }
        }

        // Initialize quarter buttons
        function initializeQuarterButtons() {
            document.querySelectorAll('.quarter-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Save current quarter's time
                    if (quarterTimerInterval) {
                        stopQuarterClock();
                    }
                    
                    document.querySelectorAll('.quarter-button').forEach(btn =>
                        btn.classList.remove('active')
                    );
                    button.classList.add('active');
                    
                    currentQuarter = button.getAttribute('data-quarter');
                    updateQuarterClock();
                    saveQuarterClockState();
                });
            });
        }

        function startQuarterClock() {
            if (quarterTimerInterval || !currentTeam) return;
            
            const currentClocks = getCurrentQuarterClocks();
            const now = Date.now();
            
            quarterStartTime = now - (currentClocks[currentQuarter] * 1000);
            quarterTimerInterval = setInterval(updateQuarterClock, 100);
            
            // Update persistent state
            quarterClockState.isRunning = true;
            quarterClockState.startTime = quarterStartTime;
            quarterClockState.elapsedTime = currentClocks[currentQuarter];
            saveQuarterClockState();
            
            // Start player timers for those on field
            teams[currentTeam]?.forEach(player => {
                if (player.onField && !player.sessionStart) {
                    player.sessionStart = now;
                    player.lastTimestamp = now;
                }
            });
            
            saveTeams();
        }

        function stopQuarterClock() {
            if (quarterTimerInterval) {
                clearInterval(quarterTimerInterval);
                quarterTimerInterval = null;
                
                if (quarterStartTime && currentTeam) {
                    const currentClocks = getCurrentQuarterClocks();
                    currentClocks[currentQuarter] = Math.floor((Date.now() - quarterStartTime) / 1000);
                    saveTeamQuarterClocks();
                }
            }
            
            // Update persistent state
            quarterClockState.isRunning = false;
            quarterClockState.startTime = null;
            const currentClocks = getCurrentQuarterClocks();
            quarterClockState.elapsedTime = currentClocks[currentQuarter];
            saveQuarterClockState();
            
            // Log all player times for those on field
            const now = Date.now();
            teams[currentTeam]?.forEach(player => {
                if (player.onField && player.sessionStart) {
                    const sessionTime = Math.floor((now - player.sessionStart) / 1000);
                    player.totalTime += sessionTime;
                    
                    // Add to rotation log
                    player.rotationLog.push({
                        in: new Date(player.sessionStart).toLocaleTimeString(),
                        out: new Date(now).toLocaleTimeString(),
                        duration: formatTime(sessionTime),
                        quarter: currentQuarter
                    });
                    
                    // Reset session tracking but keep on field
                    player.sessionStart = null;
                    player.lastTimestamp = null;
                }
            });
            
            saveTeams();
            updatePlayerDisplay();
            renderRotationLog();
        }

        function updateQuarterClock() {
            let seconds;
            if (quarterTimerInterval && quarterStartTime && currentTeam) {
                seconds = Math.floor((Date.now() - quarterStartTime) / 1000);
                const currentClocks = getCurrentQuarterClocks();
                currentClocks[currentQuarter] = seconds;
            } else {
                const currentClocks = getCurrentQuarterClocks();
                seconds = currentClocks[currentQuarter];
            }
            
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('quarter-clock').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function getCurrentQuarterClocks() {
            if (!currentTeam) return { Q1: 0, Q2: 0, Q3: 0, Q4: 0, OT: 0 };
            
            if (!teamQuarterClocks[currentTeam]) {
                teamQuarterClocks[currentTeam] = { Q1: 0, Q2: 0, Q3: 0, Q4: 0, OT: 0 };
            }
            return teamQuarterClocks[currentTeam];
        }

        function saveQuarterClockState() {
            if (!currentTeam) return;
            
            const stateToSave = {
                ...quarterClockState,
                team: currentTeam,
                quarter: currentQuarter
            };
            localStorage.setItem('quarterClockState', JSON.stringify(stateToSave));
        }

        function loadQuarterClockState() {
            try {
                const saved = localStorage.getItem('quarterClockState');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.team === currentTeam && state.isRunning) {
                        quarterClockState = state;
                        
                        // Restore the running clock
                        const now = Date.now();
                        const timeSinceStart = Math.floor((now - state.startTime) / 1000);
                        const currentClocks = getCurrentQuarterClocks();
                        currentClocks[state.quarter] = timeSinceStart;
                        
                        quarterStartTime = state.startTime;
                        quarterTimerInterval = setInterval(updateQuarterClock, 100);
                        
                        // Set active quarter
                        currentQuarter = state.quarter;
                        document.querySelectorAll('.quarter-button').forEach(btn => {
                            btn.classList.toggle('active', btn.getAttribute('data-quarter') === currentQuarter);
                        });
                    }
                }
            } catch (e) {
                console.error('Error loading quarter clock state:', e);
            }
        }

        function createTeam() {
            const teamName = prompt("Enter team name:");
            if (!teamName || teamName.trim() === '') return;

            teams[teamName] = [];
            updateTeamOptions();
            saveTeams();
        }

        function updateTeamOptions() {
            const teamSelect = document.getElementById('team-select');
            if (!teamSelect) return;
            
            const currentValue = teamSelect.value;
            teamSelect.innerHTML = '<option value="">Select Team</option>';
            Object.keys(teams).forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                if (team === currentValue) {
                    option.selected = true;
                }
                teamSelect.appendChild(option);
            });
        }

        function loadSelectedTeam() {
            currentTeam = document.getElementById('team-select').value;
            const header = document.getElementById('team-title');
            header.textContent = currentTeam ? `${currentTeam} Time Tracker` : 'Soccer Time Tracker';
            
            // Save selected team to localStorage
            if (currentTeam) {
                localStorage.setItem('selectedTeam', currentTeam);
                renderPlayerCards();
                updateCaptainOptions();
                updateGoaltenderOptions();
                renderRotationLog();
                renderEventsLog();
                updateScoreDisplay();
                updateQuarterClock();
                loadQuarterClockState();
                loadRotationTime();
                startUpdateInterval();
            } else {
                localStorage.removeItem('selectedTeam');
                document.getElementById('players').innerHTML = '';
                document.getElementById('quarter-clock').textContent = '0:00';
                stopUpdateInterval();
                
                // Clear quarter clock state
                if (quarterTimerInterval) {
                    clearInterval(quarterTimerInterval);
                    quarterTimerInterval = null;
                }
                localStorage.removeItem('quarterClockState');
            }
        }

        function renderPlayerCards() {
            if (!currentTeam) return;
            
            const container = document.getElementById('players');
            container.innerHTML = '';
            
            teams[currentTeam].forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.id = `player-${index}`;
                card.onclick = () => toggleField(index);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'player-name';
                nameDiv.textContent = player.name;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'player-time';
                timeDiv.id = `time-${index}`;
                
                card.appendChild(nameDiv);
                card.appendChild(timeDiv);
                container.appendChild(card);
            });
            
            updatePlayerDisplay();
        }

        function updatePlayerDisplay() {
            if (!currentTeam) return;
            
            const now = Date.now();
            const rotationMinutes = parseInt(document.getElementById('rotation').value) || 5;
            const rotationSeconds = rotationMinutes * 60;
            const captain = document.getElementById('captain-select').value;
            const goaltender = document.getElementById('goaltender-select').value;
            
            teams[currentTeam].forEach((player, index) => {
                const card = document.getElementById(`player-${index}`);
                const timeDiv = document.getElementById(`time-${index}`);
                
                if (!card || !timeDiv) return;
                
                let displayTime = player.totalTime;
                let sessionTime = 0;
                
                if (player.onField && player.sessionStart) {
                    sessionTime = Math.floor((now - player.sessionStart) / 1000);
                    displayTime += sessionTime;
                }
                
                timeDiv.textContent = formatTime(displayTime);
                
                // Reset classes
                card.className = 'player-card';
                
                // Remove existing icons
                const existingAlert = card.querySelector('.alert-icon');
                if (existingAlert) existingAlert.remove();
                
                // Add appropriate class based on state
                if (player.onField) {
                    card.classList.add('on-field');
                    
                    // Warning and alert states for on-field players
                    if (sessionTime >= rotationSeconds * 0.8) {
                        card.classList.add('warning');
                    }
                    if (sessionTime >= rotationSeconds) {
                        card.classList.add('alert');
                        const alertIcon = document.createElement('div');
                        alertIcon.className = 'alert-icon';
                        alertIcon.textContent = '🔔';
                        card.appendChild(alertIcon);
                        playDing();
                    }
                } else if (displayTime === 0) {
                    card.classList.add('not-played');
                }
                
                // Remove existing badges
                const existingCaptainBadge = card.querySelector('.captain-badge');
                const existingGoaltenderBadge = card.querySelector('.goaltender-badge');
                if (existingCaptainBadge) existingCaptainBadge.remove();
                if (existingGoaltenderBadge) existingGoaltenderBadge.remove();
                
                // Captain badge
                if (captain === player.name) {
                    const badge = document.createElement('div');
                    badge.className = 'captain-badge';
                    badge.textContent = '👑';
                    card.appendChild(badge);
                }
                
                // Goaltender badge
                if (goaltender === player.name) {
                    const badge = document.createElement('div');
                    badge.className = 'goaltender-badge';
                    badge.textContent = '🥅';
                    card.appendChild(badge);
                }
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function toggleField(playerIndex) {
            if (!currentTeam) return;
            
            const player = teams[currentTeam][playerIndex];
            const now = Date.now();
            
            if (player.onField) {
                // Player coming off field - remove alert and stop sounds
                const card = document.getElementById(`player-${playerIndex}`);
                const alertIcon = card?.querySelector('.alert-icon');
                if (alertIcon) alertIcon.remove();
                
                if (player.sessionStart) {
                    const sessionTime = Math.floor((now - player.sessionStart) / 1000);
                    player.totalTime += sessionTime;
                    
                    // Add to rotation log
                    player.rotationLog.push({
                        in: new Date(player.sessionStart).toLocaleTimeString(),
                        out: new Date(now).toLocaleTimeString(),
                        duration: formatTime(sessionTime),
                        quarter: currentQuarter
                    });
                    
                    player.sessionStart = null;
                    player.lastTimestamp = null;
                }
                player.onField = false;
            } else {
                // Player going on field
                player.onField = true;
                // Only start session timer if quarter clock is running
                if (quarterTimerInterval) {
                    player.sessionStart = now;
                    player.lastTimestamp = now;
                } else {
                    player.sessionStart = null;
                    player.lastTimestamp = null;
                }
            }
            
            saveTeams();
            updatePlayerDisplay();
            renderRotationLog();
        }

        function startUpdateInterval() {
            if (updateInterval) return;
            updateInterval = setInterval(updatePlayerDisplay, 1000);
        }

        function stopUpdateInterval() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        function updateCaptainOptions() {
            if (!currentTeam) return;
            
            const select = document.getElementById('captain-select');
            const currentValue = select.value;
            select.innerHTML = '<option value="">None</option>';
            
            teams[currentTeam].forEach(player => {
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = player.name;
                if (player.name === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function updateGoaltenderOptions() {
            if (!currentTeam) return;
            
            const select = document.getElementById('goaltender-select');
            const currentValue = select.value;
            select.innerHTML = '<option value="">None</option>';
            
            teams[currentTeam].forEach(player => {
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = player.name;
                if (player.name === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Event functions
        function showEventModal() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            document.getElementById('event-type').value = '';
            document.getElementById('event-options').innerHTML = '';
            document.getElementById('event-modal').style.display = 'block';
        }

        function updateEventOptions() {
            const eventType = document.getElementById('event-type').value;
            const optionsContainer = document.getElementById('event-options');
            optionsContainer.innerHTML = '';
            
            if (eventType === 'goal' || eventType === 'penalty') {
                if (eventType === 'goal') {
                    optionsContainer.innerHTML = `
                        <div style="margin-top: 20px;">
                            <label>
                                <input type="radio" name="event-team" value="team" checked> Our Team
                            </label>
                            <label style="margin-left: 20px;">
                                <input type="radio" name="event-team" value="other"> Other Team
                            </label>
                        </div>
                        <div id="event-player-container">
                            <select id="event-player">
                                <option value="">Select Player</option>
                            </select>
                        </div>
                    `;
                    
                    // Populate player options
                    const select = document.getElementById('event-player');
                    teams[currentTeam].forEach(player => {
                        const option = document.createElement('option');
                        option.value = player.name;
                        option.textContent = player.name;
                        select.appendChild(option);
                    });
                    
                    // Add event listeners for team radio buttons
                    const teamRadios = document.querySelectorAll('input[name="event-team"]');
                    teamRadios.forEach(radio => {
                        radio.addEventListener('change', updateEventPlayerVisibility);
                    });
                    
                } else if (eventType === 'penalty') {
                    optionsContainer.innerHTML = `
                        <div>
                            <label>Award penalty point to the following team:</label>
                            <div style="margin-top: 10px;">
                                <label>
                                    <input type="radio" name="penalty-team" value="team" checked> Our Team
                                </label>
                                <label style="margin-left: 20px;">
                                    <input type="radio" name="penalty-team" value="other"> Other Team
                                </label>
                            </div>
                        </div>
                    `;
                }
            } else if (eventType && eventType !== 'penalty') {
                // For other events that require player selection
                optionsContainer.innerHTML = `
                    <select id="event-player">
                        <option value="">Select Player</option>
                    </select>
                `;
                
                // Populate player options
                const select = document.getElementById('event-player');
                teams[currentTeam].forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    select.appendChild(option);
                });
            }
        }

        function updateEventPlayerVisibility() {
            const eventTeam = document.querySelector('input[name="event-team"]:checked')?.value;
            const playerContainer = document.getElementById('event-player-container');
            
            if (playerContainer) {
                if (eventTeam === 'other') {
                    playerContainer.style.display = 'none';
                    const playerSelect = document.getElementById('event-player');
                    if (playerSelect) playerSelect.value = '';
                } else {
                    playerContainer.style.display = 'block';
                }
            }
        }

        function recordEvent() {
            const eventType = document.getElementById('event-type').value;
            if (!eventType) {
                alert('Please select an event type');
                return;
            }
            
            let eventData = {
                type: eventType,
                time: new Date().toLocaleTimeString(),
                quarter: currentQuarter,
                timestamp: Date.now()
            };
            
            if (eventType === 'goal') {
                const eventTeam = document.querySelector('input[name="event-team"]:checked').value;
                let player = document.getElementById('event-player').value;
                
                if (eventTeam === 'team' && !player) {
                    alert('Please select a player');
                    return;
                }
                
                if (eventTeam === 'other') {
                    player = 'Other Team Player';
                }
                
                eventData.player = player;
                eventData.team = eventTeam;
                
            } else if (eventType === 'penalty') {
                const penaltyTeam = document.querySelector('input[name="penalty-team"]:checked').value;
                eventData.team = penaltyTeam;
                eventData.player = penaltyTeam === 'team' ? currentTeam + ' Player' : 'Other Team Player';
                
            } else {
                const player = document.getElementById('event-player').value;
                if (!player) {
                    alert('Please select a player');
                    return;
                }
                eventData.player = player;
                eventData.team = 'team';
            }
            
            if (!events[currentTeam]) {
                events[currentTeam] = [];
            }
            events[currentTeam].push(eventData);
            
            saveEvents();
            updateScoreDisplay();
            renderEventsLog();
            closeEventModal();
        }

        function closeEventModal() {
            document.getElementById('event-modal').style.display = 'none';
        }

        function showManageEventsModal() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            renderManageEventsList();
            document.getElementById('manage-events-modal').style.display = 'block';
        }

        function renderManageEventsList() {
            const container = document.getElementById('events-list');
            container.innerHTML = '';
            
            const teamEvents = events[currentTeam] || [];
            
            if (teamEvents.length === 0) {
                container.innerHTML = '<p>No events recorded yet.</p>';
                return;
            }
            
            teamEvents.forEach((event, index) => {
                const item = document.createElement('div');
                item.className = 'event-item';
                
                const info = document.createElement('div');
                info.className = 'event-info';
                const teamName = event.team === 'team' ? currentTeam : 'Other Team';
                const eventTypeMap = {
                    goal: '⚽ Goal',
                    penalty: '🚨 Penalty Point',
                    save: '🛡️ Goal Prevented',
                    injury: '🤕 Player Injury',
                    cleat: '👟 Lost Cleat',
                    laces: '👟 Untied Laces',
                    headbutt: '🤕 Ball Head-butt'
                };
                
                info.innerHTML = `
                    <strong>${eventTypeMap[event.type]}</strong><br>
                    <small>${event.player} (${teamName})<br>
                    ${event.quarter} - ${event.time}</small>
                `;
                
                const actions = document.createElement('div');
                actions.className = 'event-actions';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = '✏️ Edit';
                editBtn.className = 'edit-button';
                editBtn.onclick = () => editEvent(index);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '🗑 Delete';
                deleteBtn.className = 'delete-button';
                deleteBtn.onclick = () => deleteEvent(index);
                
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                
                item.appendChild(info);
                item.appendChild(actions);
                container.appendChild(item);
            });
        }

        function showAddEventModal() {
            document.getElementById('add-event-type').value = '';
            document.getElementById('add-event-quarter').value = currentQuarter;
            document.getElementById('add-event-options').innerHTML = '';
            document.getElementById('add-event-modal').style.display = 'block';
        }

        function updateAddEventOptions() {
            const eventType = document.getElementById('add-event-type').value;
            const optionsContainer = document.getElementById('add-event-options');
            optionsContainer.innerHTML = '';
            
            if (eventType === 'goal' || eventType === 'penalty') {
                if (eventType === 'goal') {
                    optionsContainer.innerHTML = `
                        <div style="margin-top: 20px;">
                            <label>
                                <input type="radio" name="add-event-team" value="team" checked> Our Team
                            </label>
                            <label style="margin-left: 20px;">
                                <input type="radio" name="add-event-team" value="other"> Other Team
                            </label>
                        </div>
                        <div id="add-event-player-container">
                            <select id="add-event-player">
                                <option value="">Select Player</option>
                            </select>
                        </div>
                    `;
                    
                    // Populate player options
                    const select = document.getElementById('add-event-player');
                    teams[currentTeam].forEach(player => {
                        const option = document.createElement('option');
                        option.value = player.name;
                        option.textContent = player.name;
                        select.appendChild(option);
                    });
                    
                    // Add event listeners
                    const teamRadios = document.querySelectorAll('input[name="add-event-team"]');
                    teamRadios.forEach(radio => {
                        radio.addEventListener('change', updateAddEventPlayerVisibility);
                    });
                    
                } else if (eventType === 'penalty') {
                    optionsContainer.innerHTML = `
                        <div>
                            <label>Award penalty point to the following team:</label>
                            <div style="margin-top: 10px;">
                                <label>
                                    <input type="radio" name="add-penalty-team" value="team" checked> Our Team
                                </label>
                                <label style="margin-left: 20px;">
                                    <input type="radio" name="add-penalty-team" value="other"> Other Team
                                </label>
                            </div>
                        </div>
                    `;
                }
            } else if (eventType && eventType !== 'penalty') {
                optionsContainer.innerHTML = `
                    <select id="add-event-player">
                        <option value="">Select Player</option>
                    </select>
                `;
                
                const select = document.getElementById('add-event-player');
                teams[currentTeam].forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    select.appendChild(option);
                });
            }
        }

        function updateAddEventPlayerVisibility() {
            const eventTeam = document.querySelector('input[name="add-event-team"]:checked')?.value;
            const playerContainer = document.getElementById('add-event-player-container');
            
            if (playerContainer) {
                if (eventTeam === 'other') {
                    playerContainer.style.display = 'none';
                    const playerSelect = document.getElementById('add-event-player');
                    if (playerSelect) playerSelect.value = '';
                } else {
                    playerContainer.style.display = 'block';
                }
            }
        }

        function addEvent() {
            const eventType = document.getElementById('add-event-type').value;
            const eventQuarter = document.getElementById('add-event-quarter').value;
            
            if (!eventType) {
                alert('Please select an event type');
                return;
            }
            
            let eventData = {
                type: eventType,
                time: new Date().toLocaleTimeString(),
                quarter: eventQuarter,
                timestamp: Date.now()
            };
            
            if (eventType === 'goal') {
                const eventTeam = document.querySelector('input[name="add-event-team"]:checked').value;
                let player = document.getElementById('add-event-player').value;
                
                if (eventTeam === 'team' && !player) {
                    alert('Please select a player');
                    return;
                }
                
                if (eventTeam === 'other') {
                    player = 'Other Team Player';
                }
                
                eventData.player = player;
                eventData.team = eventTeam;
                
            } else if (eventType === 'penalty') {
                const penaltyTeam = document.querySelector('input[name="add-penalty-team"]:checked').value;
                eventData.team = penaltyTeam;
                eventData.player = penaltyTeam === 'team' ? currentTeam + ' Player' : 'Other Team Player';
                
            } else {
                const player = document.getElementById('add-event-player').value;
                if (!player) {
                    alert('Please select a player');
                    return;
                }
                eventData.player = player;
                eventData.team = 'team';
            }
            
            if (!events[currentTeam]) {
                events[currentTeam] = [];
            }
            events[currentTeam].push(eventData);
            
            saveEvents();
            updateScoreDisplay();
            renderEventsLog();
            renderManageEventsList();
            closeAddEventModal();
        }

        function closeAddEventModal() {
            document.getElementById('add-event-modal').style.display = 'none';
        }

        function editEvent(index) {
            editingEventIndex = index;
            const event = events[currentTeam][index];
            
            document.getElementById('edit-event-type').value = event.type;
            updateEditEventOptions();
            
            // Set specific values based on event type
            if (event.type === 'goal') {
                if (event.team === 'team') {
                    document.querySelector('input[name="edit-event-team"][value="team"]').checked = true;
                    document.getElementById('edit-event-player').value = event.player;
                } else {
                    document.querySelector('input[name="edit-event-team"][value="other"]').checked = true;
                }
                updateEditEventPlayerVisibility();
                
            } else if (event.type === 'penalty') {
                document.querySelector(`input[name="edit-penalty-team"][value="${event.team}"]`).checked = true;
                
            } else {
                document.getElementById('edit-event-player').value = event.player;
            }
            
            document.getElementById('edit-event-modal').style.display = 'block';
        }

        function updateEditEventOptions() {
            const eventType = document.getElementById('edit-event-type').value;
            const optionsContainer = document.getElementById('edit-event-options');
            optionsContainer.innerHTML = '';
            
            if (eventType === 'goal' || eventType === 'penalty') {
                if (eventType === 'goal') {
                    optionsContainer.innerHTML = `
                        <div style="margin-top: 20px;">
                            <label>
                                <input type="radio" name="edit-event-team" value="team" checked> Our Team
                            </label>
                            <label style="margin-left: 20px;">
                                <input type="radio" name="edit-event-team" value="other"> Other Team
                            </label>
                        </div>
                        <div id="edit-event-player-container">
                            <select id="edit-event-player">
                                <option value="">Select Player</option>
                            </select>
                        </div>
                    `;
                    
                    const select = document.getElementById('edit-event-player');
                    teams[currentTeam].forEach(player => {
                        const option = document.createElement('option');
                        option.value = player.name;
                        option.textContent = player.name;
                        select.appendChild(option);
                    });
                    
                    const teamRadios = document.querySelectorAll('input[name="edit-event-team"]');
                    teamRadios.forEach(radio => {
                        radio.addEventListener('change', updateEditEventPlayerVisibility);
                    });
                    
                } else if (eventType === 'penalty') {
                    optionsContainer.innerHTML = `
                        <div>
                            <label>Award penalty point to the following team:</label>
                            <div style="margin-top: 10px;">
                                <label>
                                    <input type="radio" name="edit-penalty-team" value="team" checked> Our Team
                                </label>
                                <label style="margin-left: 20px;">
                                    <input type="radio" name="edit-penalty-team" value="other"> Other Team
                                </label>
                            </div>
                        </div>
                    `;
                }
            } else if (eventType && eventType !== 'penalty') {
                optionsContainer.innerHTML = `
                    <select id="edit-event-player">
                        <option value="">Select Player</option>
                    </select>
                `;
                
                const select = document.getElementById('edit-event-player');
                teams[currentTeam].forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    select.appendChild(option);
                });
            }
        }

        function updateEditEventPlayerVisibility() {
            const eventTeam = document.querySelector('input[name="edit-event-team"]:checked')?.value;
            const playerContainer = document.getElementById('edit-event-player-container');
            
            if (playerContainer) {
                if (eventTeam === 'other') {
                    playerContainer.style.display = 'none';
                    const playerSelect = document.getElementById('edit-event-player');
                    if (playerSelect) playerSelect.value = '';
                } else {
                    playerContainer.style.display = 'block';
                }
            }
        }

        function saveEditedEvent() {
            const eventType = document.getElementById('edit-event-type').value;
            if (!eventType) {
                alert('Please select an event type');
                return;
            }
            
            let eventData = {
                type: eventType,
                time: events[currentTeam][editingEventIndex].time,
                quarter: events[currentTeam][editingEventIndex].quarter,
                timestamp: events[currentTeam][editingEventIndex].timestamp
            };
            
            if (eventType === 'goal') {
                const eventTeam = document.querySelector('input[name="edit-event-team"]:checked').value;
                let player = document.getElementById('edit-event-player').value;
                
                if (eventTeam === 'team' && !player) {
                    alert('Please select a player');
                    return;
                }
                
                if (eventTeam === 'other') {
                    player = 'Other Team Player';
                }
                
                eventData.player = player;
                eventData.team = eventTeam;
                
            } else if (eventType === 'penalty') {
                const penaltyTeam = document.querySelector('input[name="edit-penalty-team"]:checked').value;
                eventData.team = penaltyTeam;
                eventData.player = penaltyTeam === 'team' ? currentTeam + ' Player' : 'Other Team Player';
                
            } else {
                const player = document.getElementById('edit-event-player').value;
                if (!player) {
                    alert('Please select a player');
                    return;
                }
                eventData.player = player;
                eventData.team = 'team';
            }
            
            events[currentTeam][editingEventIndex] = eventData;
            
            saveEvents();
            updateScoreDisplay();
            renderEventsLog();
            renderManageEventsList();
            closeEditEventModal();
        }

        function closeEditEventModal() {
            document.getElementById('edit-event-modal').style.display = 'none';
            editingEventIndex = -1;
        }

        function deleteEvent(index) {
            if (confirm('Are you sure you want to delete this event?')) {
                events[currentTeam].splice(index, 1);
                saveEvents();
                updateScoreDisplay();
                renderEventsLog();
                renderManageEventsList();
            }
        }

        function closeManageEventsModal() {
            document.getElementById('manage-events-modal').style.display = 'none';
        }

        function updateScoreDisplay() {
            if (!currentTeam) return;
            
            const teamEvents = events[currentTeam] || [];
            const teamScore = teamEvents.filter(event => 
                (event.type === 'goal' || event.type === 'penalty') && event.team === 'team'
            ).length;
            const otherScore = teamEvents.filter(event => 
                (event.type === 'goal' || event.type === 'penalty') && event.team === 'other'
            ).length;
            
            document.getElementById('team-score').textContent = `${currentTeam}: ${teamScore}`;
            document.getElementById('other-score').textContent = `Other: ${otherScore}`;
        }

        function renderRotationLog() {
            if (!currentTeam) return;
            
            const container = document.getElementById('rotation-log');
            container.innerHTML = '';
            
            let allRotations = [];
            teams[currentTeam].forEach(player => {
                player.rotationLog.forEach(log => {
                    allRotations.push({
                        ...log,
                        player: player.name
                    });
                });
            });
            
            allRotations.sort((a, b) => new Date('1970/01/01 ' + a.in) - new Date('1970/01/01 ' + b.in));
            
            if (allRotations.length === 0) {
                container.innerHTML = '<p>No rotations recorded yet.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>Player</th>
                    <th>Quarter</th>
                    <th>In</th>
                    <th>Out</th>
                    <th>Duration</th>
                </tr>
            `;
            
            allRotations.forEach(rotation => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${rotation.player}</td>
                    <td>${rotation.quarter}</td>
                    <td>${rotation.in}</td>
                    <td>${rotation.out}</td>
                    <td>${rotation.duration}</td>
                `;
            });
            
            container.appendChild(table);
        }

        function renderEventsLog() {
            if (!currentTeam) return;
            
            const container = document.getElementById('events-log');
            container.innerHTML = '';
            
            const teamEvents = events[currentTeam] || [];
            
            if (teamEvents.length === 0) {
                container.innerHTML = '<p>No events recorded yet.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>Event</th>
                    <th>Player</th>
                    <th>Team</th>
                    <th>Quarter</th>
                    <th>Time</th>
                </tr>
            `;
            
            const eventTypeMap = {
                goal: '⚽ Goal',
                penalty: '🚨 Penalty Point',
                save: '🛡️ Goal Prevented',
                injury: '🤕 Player Injury',
                cleat: '👟 Lost Cleat',
                laces: '👟 Untied Laces',
                headbutt: '🤕 Ball Head-butt'
            };
            
            teamEvents.forEach(event => {
                const row = table.insertRow();
                const teamName = event.team === 'team' ? currentTeam : 'Other Team';
                row.innerHTML = `
                    <td>${eventTypeMap[event.type]}</td>
                    <td>${event.player}</td>
                    <td>${teamName}</td>
                    <td>${event.quarter}</td>
                    <td>${event.time}</td>
                `;
            });
            
            container.appendChild(table);
        }

        // Share functionality
        function showShareModal() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            // Reset checkboxes to default (only events selected)
            document.getElementById('share-times').checked = false;
            document.getElementById('share-rotation').checked = false;
            document.getElementById('share-events').checked = true;
            document.getElementById('share-quarters').checked = false;
            
            document.getElementById('share-modal').style.display = 'block';
        }

        function selectAllShareOptions() {
            document.getElementById('share-times').checked = true;
            document.getElementById('share-rotation').checked = true;
            document.getElementById('share-events').checked = true;
            document.getElementById('share-quarters').checked = true;
        }

        function deselectAllShareOptions() {
            document.getElementById('share-times').checked = false;
            document.getElementById('share-rotation').checked = false;
            document.getElementById('share-events').checked = false;
            document.getElementById('share-quarters').checked = false;
        }

        function generateAndCopyShareUrl() {
            if (!currentTeam) return;
            
            const shareData = {
                teamName: currentTeam,
                team: teams[currentTeam] // Players always included
            };
            
            // Add optional data based on selections
            if (document.getElementById('share-times').checked) {
                // Include player times but clear session data for sharing
                shareData.team = shareData.team.map(player => ({
                    ...player,
                    sessionStart: null,
                    lastTimestamp: null
                }));
            } else {
                // Remove times but keep player structure
                shareData.team = shareData.team.map(player => ({
                    name: player.name,
                    totalTime: 0,
                    onField: false,
                    sessionStart: null,
                    lastTimestamp: null,
                    rotationLog: []
                }));
            }
            
            if (document.getElementById('share-rotation').checked) {
                // Rotation log is already included in team data
            } else {
                // Clear rotation logs
                shareData.team = shareData.team.map(player => ({
                    ...player,
                    rotationLog: []
                }));
            }
            
            if (document.getElementById('share-events').checked) {
                shareData.events = events[currentTeam] || [];
            }
            
            if (document.getElementById('share-quarters').checked) {
                shareData.quarterClocks = teamQuarterClocks[currentTeam] || { Q1: 0, Q2: 0, Q3: 0, Q4: 0, OT: 0 };
            }
            
            // Create compressed share URL
            const compressed = compressData(JSON.stringify(shareData));
            const encodedData = encodeURIComponent(compressed);
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Share link copied to clipboard!');
                closeShareModal();
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Share link copied to clipboard!');
                closeShareModal();
            });
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        function compressData(jsonString) {
            // Simple compression by removing unnecessary whitespace and shortening keys
            const compressed = jsonString
                .replace(/\s+/g, '')  // Remove all whitespace
                .replace(/"name":/g, '"n":')
                .replace(/"totalTime":/g, '"t":')
                .replace(/"onField":/g, '"o":')
                .replace(/"sessionStart":/g, '"s":')
                .replace(/"lastTimestamp":/g, '"l":')
                .replace(/"rotationLog":/g, '"r":')
                .replace(/"player":/g, '"p":')
                .replace(/"team":/g, '"tm":')
                .replace(/"time":/g, '"ti":')
                .replace(/"quarter":/g, '"q":')
                .replace(/"timestamp":/g, '"ts":')
                .replace(/"type":/g, '"tp":')
                .replace(/"teamName":/g, '"tn":')
                .replace(/"events":/g, '"ev":')
                .replace(/"quarterClocks":/g, '"qc":');
            
            return btoa(compressed);
        }

        function decompressData(compressedData) {
            try {
                const compressed = atob(compressedData);
                // Restore the original keys
                const restored = compressed
                    .replace(/"n":/g, '"name":')
                    .replace(/"t":/g, '"totalTime":')
                    .replace(/"o":/g, '"onField":')
                    .replace(/"s":/g, '"sessionStart":')
                    .replace(/"l":/g, '"lastTimestamp":')
                    .replace(/"r":/g, '"rotationLog":')
                    .replace(/"p":/g, '"player":')
                    .replace(/"tm":/g, '"team":')
                    .replace(/"ti":/g, '"time":')
                    .replace(/"q":/g, '"quarter":')
                    .replace(/"ts":/g, '"timestamp":')
                    .replace(/"tp":/g, '"type":')
                    .replace(/"tn":/g, '"teamName":')
                    .replace(/"ev":/g, '"events":')
                    .replace(/"qc":/g, '"quarterClocks":');
                
                return JSON.parse(restored);
            } catch (e) {
                console.error('Decompression failed:', e);
                return null;
            }
        }

        // Other utility functions
        function showManagePlayersModal() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            tempPlayers = JSON.parse(JSON.stringify(teams[currentTeam]));
            renderTempPlayers();
            document.getElementById('manage-modal').style.display = 'block';
        }

        function renderTempPlayers() {
            const container = document.getElementById('player-list');
            container.innerHTML = '';
            
            tempPlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'player-item';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = player.name;
                input.onchange = (e) => tempPlayers[index].name = e.target.value;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '🗑 Delete';
                deleteBtn.onclick = () => {
                    tempPlayers.splice(index, 1);
                    renderTempPlayers();
                };
                
                item.appendChild(input);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }

        function addPlayerFromModal() {
            const name = document.getElementById('new-player-name').value.trim();
            if (!name) return;
            
            tempPlayers.push({
                name: name,
                totalTime: 0,
                onField: false,
                sessionStart: null,
                lastTimestamp: null,
                rotationLog: []
            });
            
            document.getElementById('new-player-name').value = '';
            renderTempPlayers();
        }

        function savePlayersFromModal() {
            // Filter out empty names
            tempPlayers = tempPlayers.filter(player => player.name.trim() !== '');
            teams[currentTeam] = tempPlayers;
            
            saveTeams();
            renderPlayerCards();
            updateCaptainOptions();
            updateGoaltenderOptions();
            closeManageModal();
        }

        function closeManageModal() {
            document.getElementById('manage-modal').style.display = 'none';
        }

        // Reset functions
        function showResetWarning() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            document.getElementById('reset-warning-modal').style.display = 'block';
        }

        function closeResetWarning() {
            document.getElementById('reset-warning-modal').style.display = 'none';
        }

        function confirmReset() {
            if (!currentTeam) return;
            
            // Reset all player times and logs
            teams[currentTeam].forEach(player => {
                player.totalTime = 0;
                player.onField = false;
                player.sessionStart = null;
                player.lastTimestamp = null;
                player.rotationLog = [];
            });
            
            // Reset events
            if (events[currentTeam]) {
                events[currentTeam] = [];
            }
            
            // Reset quarter clocks for this team
            if (teamQuarterClocks[currentTeam]) {
                teamQuarterClocks[currentTeam] = { Q1: 0, Q2: 0, Q3: 0, Q4: 0, OT: 0 };
            }
            
            // Stop any running timers
            if (quarterTimerInterval) {
                clearInterval(quarterTimerInterval);
                quarterTimerInterval = null;
            }
            
            // Clear persistent state
            quarterClockState = { isRunning: false, startTime: null, elapsedTime: 0 };
            localStorage.removeItem('quarterClockState');
            
            saveTeams();
            saveEvents();
            saveTeamQuarterClocks();
            updatePlayerDisplay();
            renderRotationLog();
            renderEventsLog();
            updateScoreDisplay();
            updateQuarterClock();
            closeResetWarning();
        }

        // Import/Export functions
        function checkForImportData() {
            const urlParams = new URLSearchParams(window.location.search);
            let importData = urlParams.get('data') || urlParams.get('import'); // Support both old and new format
            
            if (importData) {
                try {
                    let teamData;
                    
                    // Try new compressed format first
                    if (urlParams.get('data')) {
                        teamData = decompressData(decodeURIComponent(importData));
                    }
                    
                    // Fallback to old format
                    if (!teamData && urlParams.get('import')) {
                        teamData = JSON.parse(atob(importData));
                    }
                    
                    if (teamData) {
                        pendingImportData = teamData;
                        document.getElementById('import-modal').style.display = 'block';
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (e) {
                    console.error('Invalid import data:', e);
                    alert('Invalid or corrupted share link. Please ask for a new link.');
                    // Remove the import parameter
                    const url = new URL(window.location);
                    url.searchParams.delete('import');
                    url.searchParams.delete('data');
                    window.history.replaceState({}, '', url);
                }
            }
        }

        function confirmImport() {
            if (!pendingImportData) return;
            
            const { team, events: importedEvents, quarterClocks, teamName } = pendingImportData;
            
            // Import team data
            teams[teamName] = team;
            if (importedEvents) {
                events[teamName] = importedEvents;
            }
            
            // Import quarter clocks if available
            if (quarterClocks) {
                teamQuarterClocks[teamName] = quarterClocks;
            }
            
            // Update UI
            updateTeamOptions();
            
            // Select the imported team
            document.getElementById('team-select').value = teamName;
            loadSelectedTeam();
            
            saveTeams();
            saveEvents();
            saveTeamQuarterClocks();
            
            // Clear import data and URL
            pendingImportData = null;
            const url = new URL(window.location);
            url.searchParams.delete('import');
            url.searchParams.delete('data');
            window.history.replaceState({}, '', url);
            
            document.getElementById('import-modal').style.display = 'none';
            alert(`Team "${teamName}" imported successfully!`);
        }

        function cancelImport() {
            pendingImportData = null;
            // Remove import parameter from URL
            const url = new URL(window.location);
            url.searchParams.delete('import');
            url.searchParams.delete('data');
            window.history.replaceState({}, '', url);
            
            document.getElementById('import-modal').style.display = 'none';
        }

        // Storage functions
        function saveTeams() {
            try {
                localStorage.setItem('soccerTeams', JSON.stringify(teams));
            } catch (e) {
                console.error('Error saving teams:', e);
            }
        }

        function saveEvents() {
            try {
                localStorage.setItem('soccerEvents', JSON.stringify(events));
            } catch (e) {
                console.error('Error saving events:', e);
            }
        }

        function saveTeamQuarterClocks() {
            try {
                localStorage.setItem('teamQuarterClocks', JSON.stringify(teamQuarterClocks));
            } catch (e) {
                console.error('Error saving quarter clocks:', e);
            }
        }

        function loadTeams() {
            try {
                const saved = localStorage.getItem('soccerTeams');
                if (saved) {
                    teams = JSON.parse(saved);
                    updateTeamOptions();
                    
                    // Load previously selected team
                    const savedTeam = localStorage.getItem('selectedTeam');
                    if (savedTeam && teams[savedTeam]) {
                        document.getElementById('team-select').value = savedTeam;
                        loadSelectedTeam();
                    }
                }
            } catch (e) {
                console.error('Error loading teams:', e);
                teams = {};
            }
        }

        function loadEvents() {
            try {
                const saved = localStorage.getItem('soccerEvents');
                if (saved) {
                    events = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading events:', e);
                events = {};
            }
        }

        function loadTeamQuarterClocks() {
            try {
                const saved = localStorage.getItem('teamQuarterClocks');
                if (saved) {
                    teamQuarterClocks = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading quarter clocks:', e);
                teamQuarterClocks = {};
            }
        }

        function loadUserPreferences() {
            // Load sound setting
            const savedSound = localStorage.getItem('soundEnabled');
            if (savedSound !== null) {
                soundEnabled = JSON.parse(savedSound);
                document.getElementById('sound-status').textContent = soundEnabled ? '🔊' : '🔇';
            }
            
            // Load controls collapsed state
            const savedCollapsed = localStorage.getItem('controlsCollapsed');
            if (savedCollapsed !== null) {
                controlsCollapsed = JSON.parse(savedCollapsed);
                const content = document.getElementById('collapsible-content');
                const toggle = document.getElementById('collapse-toggle');
                
                if (controlsCollapsed) {
                    content.classList.add('collapsed');
                    toggle.textContent = '🔽';
                }
            }
            
            // Load rotation history collapsed state
            const savedRotationCollapsed = localStorage.getItem('rotationHistoryCollapsed');
            if (savedRotationCollapsed !== null) {
                rotationHistoryCollapsed = JSON.parse(savedRotationCollapsed);
            }
            
            // Apply rotation history collapsed state
            const rotationContent = document.getElementById('rotation-log');
            const rotationToggle = document.getElementById('rotation-toggle');
            
            if (rotationHistoryCollapsed) {
                rotationContent.classList.add('collapsed');
                rotationToggle.textContent = '🔽';
            } else {
                rotationContent.classList.remove('collapsed');
                rotationToggle.textContent = '🔼';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadTeams();
            loadEvents();
            loadTeamQuarterClocks();
            loadUserPreferences();
            checkForImportData();
            updateQuarterClock();
            initializeQuarterButtons();
            
            // Handle new player name input enter key
            document.getElementById('new-player-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addPlayerFromModal();
                }
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
